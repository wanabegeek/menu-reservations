<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Menu Reservations</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f8fafc;color:#0f172a;margin:0}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid #e2e8f0;padding:10px 16px}
  .wrap{max-width:1000px;margin:0 auto;padding:16px}
  .card{background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:16px;margin-bottom:12px}
  label{font-size:14px;display:block;margin-bottom:8px}
  input,select{width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:8px}
  .row{display:grid;gap:12px}
  @media(min-width:720px){.row-3{grid-template-columns:1fr 1fr 1fr}.row-2{grid-template-columns:1fr 1fr}.row-5{grid-template-columns:1fr 1fr 1fr 1fr 1fr}}
  button{cursor:pointer;border:0;border-radius:12px;padding:10px 16px}
  .btn-dark{background:#0f172a;color:#fff}
  .btn-red{background:#e11d48;color:#fff}
  .muted{color:#64748b;font-size:12px}
</style>
<noscript>
  <div style="background:#fee2e2;color:#991b1b;padding:12px;text-align:center">This page requires JavaScript.</div>
</noscript>
</head>
<body>
<header><div class="wrap"><strong>Menu Reservation & Orders</strong> <span id="status" class="muted"></span></div></header>
<main class="wrap">

  <div class="card">
    <h3>Reservation</h3>
    <div class="row row-3">
      <label>Reservation Name<input id="res_name" placeholder="Smith Family" /></label>
      <label>Contact Details<input id="res_contact" placeholder="email or phone" /></label>
      <label>Number of People<input id="res_people" type="number" min="1" value="1" /></label>
    </div>
    <div class="row row-2" style="margin-top:8px">
      <label>Date<input id="res_date" type="date" /></label>
      <label>Time<input id="res_time" type="time" /></label>
    </div>
    <div style="margin-top:10px">
      <!-- Inline handlers ensure clicks work even if scripts move -->
      <button id="btn-build" class="btn-dark">Build Guest Forms</button>
    </div>
    <p class="muted" style="margin-top:8px">Each person must choose from at least <strong>two</strong> sections (starter/main/dessert) and at most one per section.</p>
  </div>

  <div id="guests"></div>

  <div class="card">
    <button id="btn-submit" class="btn-red">Submit</button>
  </div>

</main>

<script defer>
// Expose a tiny status so you know JS is alive
(function(){
  const statusEl = document.getElementById('status');
  function setStatus(t){ if(statusEl) statusEl.textContent = t; }
  setStatus('initialisingâ€¦');

  // ---- CONFIG: Your Apps Script Web App URL (JSONP-enabled) ----
  const ENDPOINT = 'https://script.google.com/macros/s/AKfycbwU7l5we6UwcmxZWo8tnBhzQ4iHlk1Ikx84L0r9cgSYwIpNShrjm1CsmhqB9e7jIwzS5w/exec';

  // ---- Utilities ----
  const $ = (s,c=document)=>c.querySelector(s);
  const $$ = (s,c=document)=>Array.from(c.querySelectorAll(s));
  const guestsEl = document.getElementById('guests');
  function uid(){ return 'r'+Math.random().toString(36).slice(2)+Date.now(); }
  function todayStr(){ return new Date().toISOString().slice(0,10); }

  // ---- Local store (fallback) ----
  const store = {
    key:'reservations_v1',
    all(){ try{return JSON.parse(localStorage.getItem(this.key)||'[]')}catch(_){return[]} },
    save(list){ localStorage.setItem(this.key, JSON.stringify(list)); },
    upsert(res){ const list=this.all(); const i=list.findIndex(x=>x.id===res.id);
      if(i>-1) list[i]=res; else list.push(res); this.save(list); return res.id; }
  };

  // ---- Menu options ----
  const DISHES = {
    starter:["","Soup","Salmon","Antipasto"],
    main:["","Turkey","Haddock","Beef Ragu","Aubergine"],
    dessert:["","Xmas Pudding","Gateaux","Vegan Tart"]
  };

  // ---- JSONP helpers (avoid CORS) ----
  function jsonp(url){
    return new Promise((resolve)=>{
      const cb = 'jsonp_cb_' + Math.random().toString(36).slice(2);
      window[cb] = (data)=>{ try{ resolve(data); } finally { delete window[cb]; s.remove(); } };
      const s = document.createElement('script');
      s.src = url + (url.includes('?')?'&':'?') + 'callback=' + cb;
      s.onerror = ()=>{ delete window[cb]; s.remove(); resolve({ ok:false, error:'JSONP failed' }); };
      document.body.appendChild(s);
    });
  }

  async function serverCreate(res){
    const payload = JSON.stringify({ action:'create', reservation: res });
    // 1) Try CORS-friendly fetch first (works with a proxy like Cloudflare Worker/Netlify Function)
    try{
      const r = await fetch(ENDPOINT, {
        method:'POST',
        headers:{ 'Content-Type':'text/plain' },
        body: payload,
      });
      const data = await r.json();
      return data;
    }catch(_){ /* fall through to beacon */ }

    // 2) CSP-safe, CORS-free fallback: sendBeacon (fire-and-forget)
    try{
      const ok = navigator.sendBeacon(ENDPOINT, new Blob([payload], {type:'text/plain'}));
      if(ok) return { ok:true, id: res.id, mode:'beacon' };
    }catch(_){ }

    return { ok:false, error:'network' };
  }

  // ---- Core functions (GLOBAL) ----
  window.buildGuestForms = function buildGuestForms(){
    try{
      const n = Math.max(1, parseInt($('#res_people')?.value || '1'));
      guestsEl.innerHTML='';
      for(let i=0;i<n;i++){
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <h4>Person ${i+1}</h4>
          <div class="row row-5">
            <label>Name<input class="person-name" placeholder="Full name" /></label>
            <label>Starter<select class="sel-starter">${DISHES.starter.map(o=>`<option>${o}</option>`).join('')}</select></label>
            <label>Main<select class="sel-main">${DISHES.main.map(o=>`<option>${o}</option>`).join('')}</select></label>
            <label>Dessert<select class="sel-dessert">${DISHES.dessert.map(o=>`<option>${o}</option>`).join('')}</select></label>
            <label>Allergies / Dietary<input class="person-notes" placeholder="e.g., nuts, gluten-free" /></label>
          </div>`;
        guestsEl.appendChild(card);
      }
      alert(`Built ${n} guest form(s)`);
    }catch(err){ alert('Error building forms: '+err); }
  }

  function collectReservation(){
    const reservationName = $('#res_name')?.value.trim() || '';
    const contact = $('#res_contact')?.value.trim() || '';
    const date = $('#res_date')?.value || '';
    const time = $('#res_time')?.value || '';
    const people = parseInt($('#res_people')?.value || '1');
    const guests = $$('.card', guestsEl).map(card=>{
      const q = sel => card.querySelector(sel)?.value || '';
      return {
        name: q('.person-name').trim(),
        starter: q('.sel-starter'),
        main: q('.sel-main'),
        dessert: q('.sel-dessert'),
        notes: q('.person-notes').trim()
      };
    });
    return { id: uid(), reservationName, contact, date, time, people, guests, createdAt:new Date().toISOString() };
  }

  function validate(res){
    const errs=[];
    if(!res.reservationName) errs.push('Reservation Name is required.');
    if(!res.date) errs.push('Date is required.');
    if(!res.time) errs.push('Time is required.');
    if(!Number.isInteger(res.people)||res.people<1) errs.push('Number of People must be at least 1.');
    if(res.guests.length!==res.people) errs.push('Guest forms do not match the number of people. Click "Build Guest Forms" again.');
    res.guests.forEach((g,i)=>{
      const count=[g.starter,g.main,g.dessert].filter(Boolean).length;
      if(!g.name) errs.push(`Person ${i+1}: Name is required.`);
      if(count<2) errs.push(`Person ${i+1} (${g.name||'Unnamed'}): must choose at least 2 courses.`);
      if(count>3) errs.push(`Person ${i+1} (${g.name||'Unnamed'}): too many courses.`);
    });
    return errs;
  }

  window.submitReservation = async function submitReservation(){
    try{
      const res = collectReservation();
      const errs = validate(res);
      if(errs.length){ alert('Please fix the following:

'+errs.join('
')); return; }
      // Local backup
      store.upsert(res);
      // Server submit
      const ack = await serverCreate(res);
      if(ack && ack.ok){ alert('Submitted to server. ID: ' + (ack.id || res.id)); }
      else { alert('Saved locally. Could not submit to server right now.'); console.warn('Server error:', ack); }
    }catch(err){ alert('Submit failed: ' + err); }
  }

  // Fallback delegated binding (works even without inline)
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    if(btn.id==='btn-build'){ window.buildGuestForms(); }
    if(btn.id==='btn-submit'){ window.submitReservation(); }
  });

  // Init
  function init(){
    const dateEl = document.getElementById('res_date');
    if(dateEl && !dateEl.value) dateEl.value = todayStr();
    setStatus('ready');
    console.log('[menu-reservations] init complete');
  }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', init); else init();

  // Surface JS errors while testing
  window.addEventListener('error', (e)=>{ console.error('JS error:', e?.error || e); });
})();
</script>
</body>
</html>
