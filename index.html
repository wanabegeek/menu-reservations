<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Menu Reservations</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f8fafc;color:#0f172a;margin:0}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid #e2e8f0;padding:10px 16px}
  .wrap{max-width:1000px;margin:0 auto;padding:16px}
  .card{background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:16px;margin-bottom:12px}
  label{font-size:14px;display:block;margin-bottom:8px}
  input,select{width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:8px}
  .row{display:grid;gap:12px}
  @media(min-width:720px){.row-3{grid-template-columns:1fr 1fr 1fr}.row-2{grid-template-columns:1fr 1fr}.row-5{grid-template-columns:1fr 1fr 1fr 1fr 1fr}}
  button{cursor:pointer;border:0;border-radius:12px;padding:10px 16px}
  .btn-dark{background:#0f172a;color:#fff}
  .btn-red{background:#e11d48;color:#fff}
  .muted{color:#64748b;font-size:12px}
</style>
<noscript>
  <div style="background:#fee2e2;color:#991b1b;padding:12px;text-align:center">This page requires JavaScript.</div>
</noscript>
</head>
<body>
<header><div class="wrap"><strong>Menu Reservation & Orders</strong> <span id="status" class="muted"></span></div></header>
<main class="wrap">

  <div class="card">
    <h3>Reservation</h3>
    <div class="row row-3">
      <label>Reservation Name<input id="res_name" placeholder="Smith Family" /></label>
      <label>Contact Details<input id="res_contact" placeholder="email or phone" /></label>
      <label>Number of People<input id="res_people" type="number" min="1" value="1" /></label>
    </div>
    <div class="row row-2" style="margin-top:8px">
      <label>Date<input id="res_date" type="date" /></label>
      <label>Time<input id="res_time" type="time" /></label>
    </div>
    <div style="margin-top:10px">
      <!-- Inline handlers ensure clicks work even if scripts move -->
      <button id="btn-build" class="btn-dark" onclick="window.buildGuestForms && window.buildGuestForms()">Build Guest Forms</button>
    </div>
    <p class="muted" style="margin-top:8px">Each person must choose from at least <strong>two</strong> sections (starter/main/dessert) and at most one per section.</p>
  </div>

  <div id="guests"></div>

  <div class="card">
    <button id="btn-submit" class="btn-red" onclick="window.submitReservation && window.submitReservation()">Submit</button>
  </div>

</main>

<script>
(function(){
  // Point to the Worker, NOT Apps Script directly:
  const ENDPOINT = 'https://menu-reservations-worker.neil-kennedy2207.workers.dev/';

  const $ = (s,c=document)=>c.querySelector(s);
  const $$ = (s,c=document)=>Array.from(c.querySelectorAll(s));
  const guestsEl = document.getElementById('guests');

  function uid(){ return 'r'+Math.random().toString(36).slice(2)+Date.now(); }
  function todayStr(){ return new Date().toISOString().slice(0,10); }

  const store = {
    key:'reservations_v1',
    all(){ try{return JSON.parse(localStorage.getItem(this.key)||'[]')}catch(_){return[]} },
    save(list){ localStorage.setItem(this.key, JSON.stringify(list)); },
    upsert(res){ const list=this.all(); const i=list.findIndex(x=>x.id===res.id);
      if(i>-1) list[i]=res; else list.push(res); this.save(list); return res.id; }
  };

  const DISHES = {
    starter:["","Soup","Salmon","Antipasto"],
    main:["","Turkey","Haddock","Beef Ragu","Aubergine"],
    dessert:["","Xmas Pudding","Gateaux","Vegan Tart"]
  };

  function buildGuestForms(){
    const n = Math.max(1, parseInt($('#res_people').value || '1'));
    guestsEl.innerHTML='';
    for(let i=0;i<n;i++){
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <h4>Person ${i+1}</h4>
        <div class="row row-5">
          <label>Name<input class="person-name" placeholder="Full name" /></label>
          <label>Starter<select class="sel-starter">${DISHES.starter.map(o=>`<option>${o}</option>`).join('')}</select></label>
          <label>Main<select class="sel-main">${DISHES.main.map(o=>`<option>${o}</option>`).join('')}</select></label>
          <label>Dessert<select class="sel-dessert">${DISHES.dessert.map(o=>`<option>${o}</option>`).join('')}</select></label>
          <label>Allergies / Dietary<input class="person-notes" placeholder="e.g., nuts, gluten-free" /></label>
        </div>`;
      guestsEl.appendChild(card);
    }
    alert(`Built ${n} guest form(s)`);
  }

  function collectReservation(){
    const reservationName = $('#res_name').value.trim();
    const contact = $('#res_contact').value.trim();
    const date = $('#res_date').value;
    const time = $('#res_time').value;
    const people = parseInt($('#res_people').value || '1');
    const guests = $$('.card', guestsEl).map(card=>{
      const q = sel => card.querySelector(sel)?.value || '';
      return {
        name: q('.person-name').trim(),
        starter: q('.sel-starter'),
        main: q('.sel-main'),
        dessert: q('.sel-dessert'),
        notes: q('.person-notes').trim()
      };
    });
    return { id: uid(), reservationName, contact, date, time, people, guests, createdAt:new Date().toISOString() };
  }

  function validate(res){
    const errs=[];
    if(!res.reservationName) errs.push('Reservation Name is required.');
    if(!res.date) errs.push('Date is required.');
    if(!res.time) errs.push('Time is required.');
    if(!Number.isInteger(res.people)||res.people<1) errs.push('Number of People must be at least 1.');
    if(res.guests.length!==res.people) errs.push('Guest forms do not match the number of people. Click "Build Guest Forms" again.');
    res.guests.forEach((g,i)=>{
      const count=[g.starter,g.main,g.dessert].filter(Boolean).length;
      if(!g.name) errs.push(`Person ${i+1}: Name is required.`);
      if(count<2) errs.push(`Person ${i+1} (${g.name||'Unnamed'}): must choose at least 2 courses.`);
      if(count>3) errs.push(`Person ${i+1} (${g.name||'Unnamed'}): too many courses.`);
    });
    return errs;
  }

  // ---- Server calls via the Worker (CORS headers added there) ----
  async function serverCreate(res){
    const r = await fetch(ENDPOINT, {
      method:'POST',
      headers:{ 'Content-Type':'text/plain' }, // keep it 'simple'
      body: JSON.stringify({ action:'create', reservation: res })
    });
    // If the Worker is set, this will be readable
    return await r.json();
  }

  // Bind after DOM ready
  function bind(){
    document.getElementById('res_date').value ||= todayStr();
    document.getElementById('btn-build').addEventListener('click', buildGuestForms);
    document.getElementById('btn-submit').addEventListener('click', async ()=>{
      const res = collectReservation();
      const errs = validate(res);
      if(errs.length){ alert('Please fix the following:\n\n'+errs.join('\n')); return; }
      store.upsert(res);
      try{
        const ack = await serverCreate(res);
        if(ack && ack.ok) alert('Submitted to server. ID: ' + (ack.id || res.id));
        else alert('Saved locally. Could not submit to server right now.');
      }catch(err){
        alert('Saved locally. Could not submit to server right now.');
        console.warn(err);
      }
    });
  }
  if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', bind); else bind();
})();
</script>

